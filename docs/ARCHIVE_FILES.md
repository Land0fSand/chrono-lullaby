# 📦 Archive 文件说明

ChronoLullaby 系统使用多个 archive 文件来追踪和管理视频的下载与发送状态。

---

## 📋 文件类型

### 1. **下载记录** (全局共享)

📄 **文件路径**: `data/download_archive.txt`

**作用**: 
- 记录所有已下载的YouTube视频，避免重复下载
- **所有频道组共享**同一个文件

**格式**: yt-dlp 标准格式
```
youtube cBUvP4MPfcc
youtube sbK0XHQ5QRw
youtube vIVocspSns8
```

**用途**:
- ✅ yt-dlp 自动检查，跳过已下载视频
- ✅ 适用于所有频道组

---

### 2. **发送记录** (每个TG频道独立)

每个 Telegram 频道会生成**两个独立的**发送记录文件：

#### 🤖 机器格式 (给程序用)

📄 **文件路径**: `data/sent_archive_{CHAT_ID}.txt`

**格式**: yt-dlp 兼容格式
```
youtube cBUvP4MPfcc
youtube sbK0XHQ5QRw
youtube vIVocspSns8
```

**用途**:
- ✅ 追踪每个频道已发送的视频
- ✅ 可用于未来的防重复发送检查
- ✅ 与 yt-dlp 格式兼容

---

#### 👤 人类可读格式 (给用户看)

📄 **文件路径**: `data/sent_archive_{CHAT_ID}_readable.txt`

**格式**: 带标题的可读格式
```
cBUvP4MPfcc [【关灯拆电影】国际悬赏令]
sbK0XHQ5QRw [【关灯拆电影】罗斯柴尔德与金融的战争]
vIVocspSns8 [卢比奥：川普又当爹又当妈的]
```

**注意**: 
- 每行格式：`{video_id} [{title}]`
- video_id 是 YouTube 视频的唯一标识符（11位字符）
- title 是视频标题（可能被截断以避免过长）

**用途**:
- ✅ 方便用户查看每个频道发送历史
- ✅ 快速识别视频内容
- ✅ 审计和管理发送记录

---

## 🗂️ 文件命名规则

### Chat ID 清理规则
- 移除负号 `-`
- 移除加号 `+`
- 只保留数字

### 示例

| Telegram Chat ID | 机器格式文件名 | 人类可读文件名 |
|-----------------|-------------|--------------|
| `-1002441077579` | `sent_archive_1002441077579.txt` | `sent_archive_1002441077579_readable.txt` |
| `-1003009234603` | `sent_archive_1003009234603.txt` | `sent_archive_1003009234603_readable.txt` |
| `-1003128921390` | `sent_archive_1003128921390.txt` | `sent_archive_1003128921390_readable.txt` |

---

## 🔄 工作流程

```
┌─────────────────────────────────────────────────────────────┐
│                    YouTube 下载器                             │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
           ┌────────────────────────┐
           │ 下载视频到 audio_folder │
           └────────────┬───────────┘
                        │
                        ▼
           ┌────────────────────────┐
           │ 记录到 download_archive │  ◄── 全局共享
           │  (避免重复下载)         │
           └────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                    Telegram Bot                              │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
          ┌─────────────────────────┐
          │ 发现 audio_folder 中的   │
          │ 新文件                   │
          └────────────┬────────────┘
                       │
                       ▼
          ┌─────────────────────────┐
          │ 发送文件到 Telegram       │
          └────────────┬────────────┘
                       │
                       ▼
          ┌─────────────────────────┐
          │ 记录到 sent_archive_*    │  ◄── 每个频道独立
          │  (机器格式 + 人类格式)    │
          └────────────┬────────────┘
                       │
                       ▼
          ┌─────────────────────────┐
          │ 删除音频文件             │
          └─────────────────────────┘
```

---

## 📊 查看发送记录

### 查看机器格式
```powershell
Get-Content data/sent_archive_1002441077579.txt
```

### 查看人类可读格式
```powershell
Get-Content data/sent_archive_1002441077579_readable.txt
```

### 统计已发送数量
```powershell
# 机器格式
(Get-Content data/sent_archive_1002441077579.txt | Measure-Object -Line).Lines

# 人类可读格式
(Get-Content data/sent_archive_1002441077579_readable.txt | Measure-Object -Line).Lines
```

### 搜索特定视频
```powershell
# 搜索 video_id
Select-String -Path data/sent_archive_*_readable.txt -Pattern "sbK0XHQ5QRw"

# 搜索标题关键词
Select-String -Path data/sent_archive_*_readable.txt -Pattern "关灯拆电影"
```

---

## 🔍 常见问题

### Q: 为什么要分机器格式和人类格式？

**A:** 
- **机器格式**: 与 yt-dlp 兼容，可用于程序逻辑（例如防重复）
- **人类格式**: 方便用户查看和管理，无需打开浏览器查询 video_id

### Q: 如果我手动删除了 sent_archive 文件会怎样？

**A:** 
- Bot 会重新创建文件
- 不会影响下载逻辑（因为 download_archive 是独立的）
- 但会丢失该频道的发送历史记录

### Q: sent_archive 文件会无限增长吗？

**A:** 
- 是的，每发送一个视频就会增加一行
- 但文本文件体积很小，几千条记录也就几百KB
- 如需清理，可以手动删除或归档旧文件

### Q: 各个频道的 sent_archive 文件是独立的吗？

**A:** 
- ✅ **是的**，每个 Telegram 频道都有自己的 sent_archive 文件
- ✅ 这样可以精确追踪每个频道的发送历史
- ✅ 不同频道可以发送相同的视频，互不影响

---

## 🎯 设计优势

| 特性 | download_archive | sent_archive (机器) | sent_archive (可读) |
|-----|-----------------|-------------------|-------------------|
| **作用域** | 全局（所有频道组） | 单个 TG 频道 | 单个 TG 频道 |
| **格式** | yt-dlp 格式 | yt-dlp 格式 | 人类可读 |
| **用途** | 避免重复下载 | 追踪发送历史 | 用户查看 |
| **程序使用** | ✅ yt-dlp 自动读取 | ✅ 可用于防重复 | ❌ 仅供查看 |
| **文件大小** | 中等 | 小 | 中等 |

---

## 🛠️ 维护建议

1. **定期检查** `sent_archive_*_readable.txt` 确认发送记录正确
2. **备份** `download_archive.txt` 和 `sent_archive_*.txt`，避免意外丢失
3. **归档旧记录**：如果文件过大，可以定期移动到备份目录
4. **监控文件大小**：虽然文本文件很小，但长期运行可能需要定期清理

---

**最后更新**: 2025-10-10  
**版本**: v2.0

