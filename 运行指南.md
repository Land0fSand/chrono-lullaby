# ChronoLullaby 运行指南

现在所有脚本都已经更新支持 Poetry 环境！还提供了全局命令支持。

## 🌟 全局命令（推荐）

将脚本添加到环境变量 PATH 后，可以在任何地方使用：

```powershell
# 启动服务
ch

# 查看状态
ch-status

# 查看日志
ch-logs

# 停止服务
ch-stop
```

### 🔧 设置全局命令：

1. 将以下脚本复制到一个在 PATH 中的目录：

   - `ch.ps1`
   - `ch-status.ps1`
   - `ch-logs.ps1`
   - `ch-stop.ps1`

2. 或者将项目根目录添加到 PATH 环境变量中

## 🚀 本地启动方案

### 方案 1: 交互式启动（推荐调试时使用）

```powershell
./start.ps1
```

- 在独立窗口中启动两个进程
- 按任意键停止所有进程
- 进程 PID 可见

### 方案 2: 后台运行（推荐长期运行）

```powershell
# 启动
./start-background.ps1

# 检查状态
./status.ps1

# 查看日志
./logs.ps1

# 实时跟踪日志
./tail-logs.ps1

# 停止
./stop.ps1
```

- 进程在后台隐藏运行
- 不占用终端窗口
- 进程信息保存在 process_info.json
- **自动记录日志到 logs/ 目录**

### 方案 3: 简化版启动（推荐查看输出）

```powershell
./start-simple.ps1
```

- 在当前终端显示两个程序的混合输出
- 使用 PowerShell Job 技术
- 按 Ctrl+C 停止

### 方案 4: Python 版本

```powershell
cd src
poetry run python launcher.py
```

- 使用 Python multiprocessing
- 更好的错误处理
- 按 Ctrl+C 停止

## 📋 必要条件

1. **Poetry 环境**: 确保已安装 poetry 并且项目依赖已安装

   ```powershell
   poetry install
   ```

2. **环境变量**: 确保`.env`文件配置正确，包含：
   - `BOT_TOKEN`
   - `CHAT_ID`

## 🛠️ 故障排除

### 如果启动失败：

1. 检查 Poetry 是否安装：`poetry --version`
2. 检查项目依赖：`poetry install`
3. 手动测试单个脚本：
   ```powershell
   cd src
   poetry run python yt_dlp_downloader.py
   poetry run python telegram_bot.py
   ```

### 如果进程无法停止：

1. 使用任务管理器手动结束 Python/Poetry 进程
2. 或者运行：`Get-Process *python* | Stop-Process -Force`

## 🎯 推荐使用流程

1. **首次运行**: 使用`./start.ps1`确保一切正常
2. **日常使用**: 使用`./start-background.ps1`后台运行
3. **调试问题**: 使用`./start-simple.ps1`查看输出日志
4. **检查状态**: 定期运行`./status.ps1`

## 📋 日志管理

后台运行时，所有输出都会自动保存到 `logs/` 目录：

### 查看日志的方法：

```powershell
# 全局命令方式（推荐）
ch-logs                                    # 查看所有日志（最近50行）
ch-logs -Type downloader                   # 只看下载器日志
ch-logs -Type bot                          # 只看机器人日志
ch-logs -Type error                        # 查看错误日志
ch-logs -Type downloader -Follow           # 实时跟踪日志
ch-logs -Lines 100                         # 查看更多行数
ch-logs -List                              # 列出所有日志文件

# 本地命令方式
./logs.ps1                                 # 查看所有日志
./logs.ps1 -Type downloader -Follow        # 实时跟踪下载器日志
./tail-logs.ps1                            # 实时跟踪混合日志
```

### 日志文件结构：

```
logs/
├── downloader_2024-01-15_14-30-25.log       # 下载器正常输出
├── downloader_error_2024-01-15_14-30-25.log # 下载器错误输出
├── bot_2024-01-15_14-30-25.log              # 机器人正常输出
└── bot_error_2024-01-15_14-30-25.log        # 机器人错误输出
```

## 💡 额外功能

- `process_info.json`: 保存进程信息和日志路径
- 彩色输出：区分不同类型的消息
- 错误处理：网络错误自动重试
- 优雅停止：正确清理资源
- **完整的日志系统**：后台运行时不错过任何信息

现在你只需要一个命令就能启动整个系统了！🎉
