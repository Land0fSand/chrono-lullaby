# 文件名清理规则更新说明

## 📅 更新时间
2025-10-10

## 🔄 修改内容

### 旧规则（restrictive）
只保留以下字符，其他全部替换为 `_`：
- 字母数字：`a-z A-Z 0-9`
- 特定符号：`空格 . - _ ( )`

### 新规则（智能化）
**保留所有可见字符**，只替换：
- ❌ 文件系统非法字符：`< > : " / \ | ? *`
- ❌ 不可见字符（控制字符、零宽字符等）

## 📊 对比示例

| 原标题 | 旧规则 | 新规则 |
|--------|--------|--------|
| `【深度】中国经济：真相与未来` | `_深度_中国经济_真相与未来` | `【深度】中国经济：真相与未来` ✨ |
| `Hello, World! 你好世界！` | `Hello_ World_ 你好世界_` | `Hello, World! 你好世界！` ✨ |
| `Song #1: Best Mix ♫ 🎵` | `Song _1_ Best Mix _ _` | `Song #1_ Best Mix ♫ 🎵` ✨ |
| `100% Free! 完全免费！` | `100_ Free_ 完全免费_` | `100% Free! 完全免费！` ✨ |
| `表情测试😊❤️🎉` | `表情测试____` | `表情测试😊❤️🎉` ✨ |
| `测试「引号」和『书名号』` | `测试_引号_和_书名号_` | `测试「引号」和『书名号』` ✨ |
| `特殊符号@#$%&*+=~` | `特殊符号_________` | `特殊符号@#$%&_+=~` ✨ |
| `A/B测试 \| C\D测试` | `A_B测试 _ C_D测试` | `A_B测试 _ C_D测试` ✅ |
| `Path<>Test?.txt` | `Path__Test_.txt` | `Path__Test_.txt` ✅ |

**说明：**
- ✨ 新规则更好地保留了原始内容
- ✅ 非法字符正确替换，两种规则结果相同

## 🎯 保留的字符类别

1. **中文字符** - 汉字、假名、韩文等
2. **英文字母** - A-Z, a-z
3. **数字** - 0-9
4. **中文标点** - 。，、；：？！""''「」『』【】（）《》
5. **英文标点** - . , ; ! ? ' (部分，排除非法字符)
6. **空格** - 单个空格
7. **特殊符号** - @ # $ % & + = ~ 等（排除非法字符）
8. **表情符号** - 😊 ❤️ 🎉 🎵 等
9. **数学符号** - ± × ÷ ≈ ≠ 等
10. **货币符号** - ￥ € £ $ 等

## ❌ 被替换的字符

### 文件系统非法字符（9个）：
```
< > : " / \ | ? *
```

这些字符在 Windows/Linux/macOS 文件系统中有特殊含义，必须替换。

### 不可见字符：
- 控制字符（ASCII 0x00-0x1F, 0x7F）
- 零宽空格（\u200b）
- 零宽连接符（\u200c, \u200d）
- 其他不可打印字符

## 💻 代码实现

### 文件位置
`src/task/dl_audio.py`

### 核心函数
```python
# 文件系统非法字符（Windows + Linux）
ILLEGAL_FILENAME_CHARS = '<>:"/\\|?*'


def sanitize_filename(filename: str) -> str:
    """
    智能清理文件名：
    - 保留所有可见字符（中文、英文、标点、表情、特殊符号等）
    - 只替换文件系统非法字符和不可见字符
    
    Args:
        filename: 原始文件名
    
    Returns:
        清理后的安全文件名
    """
    result = []
    for char in filename:
        # 检查是否为文件系统非法字符
        if char in ILLEGAL_FILENAME_CHARS:
            result.append('_')
        # 检查是否为可打印字符（排除控制字符、零宽字符等不可见字符）
        elif char.isprintable():
            result.append(char)
        # 不可见字符替换为下划线
        else:
            result.append('_')
    
    return ''.join(result)
```

### 使用位置
第 480-481 行：
```python
safe_title = sanitize_filename(fulltitle)
safe_uploader = sanitize_filename(uploader)
```

## 📝 注意事项

1. **向后兼容**：新规则生成的文件名可能与旧文件名不同
2. **下载记录**：已下载的视频不会重复下载（通过 download_archive.txt）
3. **文件重命名**：如需统一文件名，请手动重命名现有文件
4. **特殊情况**：极少数视频标题包含大量特殊字符可能导致文件名过长

## 🚀 生效说明

- ✅ 代码已修改并验证通过
- ✅ 无 linter 错误
- ✅ 下次下载视频时自动使用新规则
- ℹ️ 已存在的文件不受影响

## 🧪 测试验证

已通过 12 组测试用例验证：
- ✅ 中文标点保留
- ✅ 英文标点保留
- ✅ 表情符号保留
- ✅ 特殊符号保留
- ✅ 非法字符正确替换
- ✅ 不可见字符正确替换

## 📚 相关文件

- `src/task/dl_audio.py` - 主要修改文件
- `download_archive.txt` - 下载记录（避免重复下载）
- `au/` - 音频文件存储目录



